<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Test Real XML Export</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>üß™ Test Real XML Export</h1>
    
    <div class="test-section">
        <h2>Step 1: Load Real XML</h2>
        <button onclick="loadXML()">Load 2300120746.xml</button>
        <div id="xml-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Step 2: Process with DIProcessor</h2>
        <button onclick="processXML()" disabled id="process-btn">Process XML</button>
        <div id="process-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Step 3: Calculate with ComplianceCalculator</h2>
        <button onclick="calculateCompliance()" disabled id="calc-btn">Calculate Compliance</button>
        <div id="calc-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Step 4: Export to Excel</h2>
        <button onclick="exportExcel()" disabled id="export-btn">Export Excel</button>
        <div id="export-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Field Verification</h2>
        <div id="field-check"></div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="di-processing/js/DIProcessor.js"></script>
    <script src="di-processing/js/ComplianceCalculator.js"></script>
    <script src="di-processing/js/ExcelExporter.js"></script>
    <script src="shared/js/ItemCalculator.js"></script>
    
    <script>
        let xmlContent = null;
        let diData = null;
        let calculationData = null;
        
        async function loadXML() {
            try {
                const response = await fetch('samples/2300120746.xml');
                xmlContent = await response.text();
                
                document.getElementById('xml-status').innerHTML = `
                    <div class="success">‚úÖ XML loaded successfully (${(xmlContent.length/1024).toFixed(2)} KB)</div>
                `;
                document.getElementById('process-btn').disabled = false;
            } catch (error) {
                document.getElementById('xml-status').innerHTML = `
                    <div class="error">‚ùå Error loading XML: ${error.message}</div>
                `;
            }
        }
        
        function processXML() {
            try {
                const processor = new DIProcessor();
                diData = processor.parseXML(xmlContent);
                
                // Check critical fields
                const add1 = diData.adicoes?.[0];
                const fieldChecks = [
                    { name: 'numero_di', value: diData.numero_di },
                    { name: 'data_registro', value: diData.data_registro },
                    { name: 'importador.endereco_uf', value: diData.importador?.endereco_uf },
                    { name: 'adicoes[0].ncm', value: add1?.ncm },
                    { name: 'adicoes[0].descricao_ncm', value: add1?.descricao_ncm },
                    { name: 'adicoes[0].condicao_venda_valor_moeda', value: add1?.condicao_venda_valor_moeda },
                    { name: 'adicoes[0].condicao_venda_valor_reais', value: add1?.condicao_venda_valor_reais },
                    { name: 'adicoes[0].condicao_venda_incoterm', value: add1?.condicao_venda_incoterm },
                    { name: 'adicoes[0].condicao_venda_local', value: add1?.condicao_venda_local },
                    { name: 'adicoes[0].peso_liquido', value: add1?.peso_liquido },
                    { name: 'adicoes[0].quantidade_estatistica', value: add1?.quantidade_estatistica },
                    { name: 'adicoes[0].unidade_estatistica', value: add1?.unidade_estatistica },
                    { name: 'adicoes[0].taxa_cambio', value: add1?.taxa_cambio }
                ];
                
                let html = '<div class="data"><h3>Extracted DI Data:</h3><ul>';
                fieldChecks.forEach(check => {
                    const status = (check.value !== undefined && check.value !== null) ? '‚úÖ' : '‚ùå';
                    const displayValue = check.value !== undefined ? check.value : 'MISSING';
                    html += `<li>${status} ${check.name}: ${displayValue}</li>`;
                });
                html += '</ul></div>';
                
                document.getElementById('process-status').innerHTML = html;
                document.getElementById('calc-btn').disabled = false;
                
                // Store globally for debugging
                window.currentDI = diData;
                
            } catch (error) {
                document.getElementById('process-status').innerHTML = `
                    <div class="error">‚ùå Error processing XML: ${error.message}</div>
                `;
            }
        }
        
        async function calculateCompliance() {
            try {
                const calculator = new ComplianceCalculator();
                
                // Configure calculator
                await calculator.inicializar();
                calculator.setEstadoDestino(diData.importador?.endereco_uf || 'GO');
                
                // Calculate
                calculationData = await calculator.calcularImpostosDI(diData, {
                    automaticas: {
                        siscomex: 493.56,
                        afrmm: 0,
                        total: 493.56
                    },
                    extras_tributaveis: 0,
                    extras_custos: 0,
                    total_base_icms: 493.56,
                    total_custos: 493.56
                });
                
                let html = '<div class="data"><h3>Calculation Results:</h3><ul>';
                html += `<li>‚úÖ Estado: ${calculationData.estado}</li>`;
                html += `<li>‚úÖ Total Impostos: R$ ${calculationData.totais?.total_impostos?.toFixed(2)}</li>`;
                html += `<li>‚úÖ Custo Total: R$ ${calculationData.totais?.custo_total?.toFixed(2)}</li>`;
                html += `<li>‚úÖ Produtos Individuais: ${calculationData.produtos_individuais?.length || 0} items</li>`;
                html += '</ul></div>';
                
                document.getElementById('calc-status').innerHTML = html;
                document.getElementById('export-btn').disabled = false;
                
                // Store globally for debugging
                window.currentCalculation = calculationData;
                
            } catch (error) {
                document.getElementById('calc-status').innerHTML = `
                    <div class="error">‚ùå Error calculating: ${error.message}</div>
                `;
            }
        }
        
        function exportExcel() {
            try {
                const exporter = new ExcelExporter();
                const result = exporter.exportCompleto(diData, calculationData);
                
                // Check the exported Excel structure
                const wb = exporter.workbook;
                const add001Sheet = wb.Sheets['Add_001'];
                
                if (add001Sheet) {
                    const data = XLSX.utils.sheet_to_json(add001Sheet, {header: 1});
                    
                    // Check specific cells for N/D values
                    const checks = [];
                    for (let row = 0; row < Math.min(20, data.length); row++) {
                        if (data[row] && data[row][1] === 'N/D') {
                            checks.push(`Row ${row+1}: ${data[row][0]} = N/D`);
                        }
                    }
                    
                    let html = '<div class="data"><h3>Excel Export Results:</h3>';
                    html += `<p class="success">‚úÖ Excel exported: ${result.filename}</p>`;
                    
                    if (checks.length > 0) {
                        html += '<p class="error">‚ö†Ô∏è Fields with N/D values:</p><ul>';
                        checks.forEach(check => {
                            html += `<li>${check}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p class="success">‚úÖ All fields have values (no N/D found)</p>';
                    }
                    html += '</div>';
                    
                    document.getElementById('export-status').innerHTML = html;
                } else {
                    document.getElementById('export-status').innerHTML = `
                        <div class="error">‚ùå Add_001 sheet not found in Excel</div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('export-status').innerHTML = `
                    <div class="error">‚ùå Error exporting: ${error.message}</div>
                `;
            }
        }
    </script>
</body>
</html>