/**
 * Testes de Valida√ß√£o: Sistema sem Fallbacks localStorage
 * 
 * Testa que o sistema falha corretamente quando:
 * - APIs n√£o est√£o dispon√≠veis
 * - Banco de dados est√° vazio
 * - Dados obrigat√≥rios est√£o ausentes
 * 
 * Garante que sistema N√ÉO usa localStorage como fallback
 * 
 * @version 1.0.0
 * @author Expertzy System
 */

import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8889';

test.describe('Valida√ß√£o: Sistema sem Fallbacks', () => {

  test.beforeEach(async ({ page }) => {
    page.setDefaultTimeout(30000);
    
    // Capturar erros de console
    page.on('console', msg => {
      if (msg.type() === 'error') {
        console.log('‚ùå Console Error:', msg.text());
      }
    });
    
    // Limpar storage antes de cada teste
    await page.evaluate(() => {
      localStorage.clear();
      sessionStorage.clear();
    });
  });

  test('TESTE: Banco vazio ‚Üí Sistema falha corretamente', async ({ page }) => {
    console.log('üï≥Ô∏è Testando comportamento com banco vazio...');
    
    // Limpar banco de dados
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    await page.click('button:has-text("Limpar Banco")');
    await page.click('button:has-text("Confirmar")');
    await page.waitForTimeout(2000);
    
    // Navegar para Module 2
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Verificar que gate de continua√ß√£o aparece
    await expect(page.locator('.gate-database-empty, .no-data-message')).toBeVisible({ timeout: 30000 });
    
    // Verificar mensagem espec√≠fica sobre banco vazio
    const gateMessage = await page.locator('.gate-database-empty, .no-data-message');
    await expect(gateMessage).toContainText(/banco.*vazio|nenhuma.*encontrada/i);
    
    // Verificar que interface principal est√° bloqueada
    const diSelector = page.locator('select[name="di_number"], #di-select');
    const isDisabled = await diSelector.isDisabled();
    if (!isDisabled) {
      // Se n√£o estiver desabilitado, verificar se tem apenas op√ß√£o padr√£o
      const optionCount = await diSelector.locator('option').count();
      expect(optionCount).toBeLessThanOrEqual(1);
    }
    
    console.log('‚úÖ Sistema detecta banco vazio e bloqueia interface');
  });

  test('TESTE: APIs indispon√≠veis ‚Üí Erro expl√≠cito', async ({ page }) => {
    console.log('üö´ Testando comportamento com APIs indispon√≠veis...');
    
    // Interceptar e bloquear APIs
    await page.route('**/api/endpoints/**', route => {
      route.abort('failed');
    });
    
    // Tentar navegar para Module 2
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Aguardar tentativas de carregamento falharem
    await page.waitForTimeout(5000);
    
    // Verificar que erro √© exibido (n√£o fallback para localStorage)
    const errorMessages = page.locator('.error-message, .api-error, .connection-error');
    const hasError = await errorMessages.count() > 0;
    
    if (hasError) {
      await expect(errorMessages.first()).toBeVisible();
      console.log('‚úÖ Sistema exibe erro quando APIs falham');
    } else {
      // Se n√£o h√° mensagem de erro vis√≠vel, verificar que interface n√£o carregou dados
      const diSelector = page.locator('select[name="di_number"], #di-select');
      const optionCount = await diSelector.locator('option').count();
      expect(optionCount).toBeLessThanOrEqual(1); // Apenas op√ß√£o padr√£o
      console.log('‚úÖ Sistema n√£o carrega dados quando APIs falham');
    }
  });

  test('TESTE: localStorage limpo ‚Üí Nenhum fallback', async ({ page }) => {
    console.log('üßπ Testando que localStorage n√£o √© usado como fallback...');
    
    // Primeiro, simular dados no localStorage (que n√£o devem ser usados)
    await page.evaluate(() => {
      localStorage.setItem('expertzy_fake_di', JSON.stringify({
        numero_di: 'FAKE123',
        adicoes: [{ numero_adicao: 1, valor: 1000 }]
      }));
      localStorage.setItem('currentDI', JSON.stringify({
        numero_di: 'FAKE456',
        adicoes: [{ numero_adicao: 1, valor: 2000 }]
      }));
    });
    
    // Navegar para Module 2 com banco vazio
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    await page.click('button:has-text("Limpar Banco")');
    await page.click('button:has-text("Confirmar")');
    
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Verificar que dados fake do localStorage N√ÉO aparecem
    const diSelector = page.locator('select[name="di_number"], #di-select');
    
    // N√£o deve ter DIs FAKE123 ou FAKE456
    await expect(diSelector.locator('option:has-text("FAKE123")')).toHaveCount(0);
    await expect(diSelector.locator('option:has-text("FAKE456")')).toHaveCount(0);
    
    // Verificar que gate de banco vazio aparece
    await expect(page.locator('.gate-database-empty, .no-data-message')).toBeVisible();
    
    console.log('‚úÖ Sistema ignora localStorage e mostra banco vazio');
  });

  test('TESTE: Dados inv√°lidos ‚Üí Fail-fast expl√≠cito', async ({ page }) => {
    console.log('‚ö†Ô∏è Testando fail-fast com dados inv√°lidos...');
    
    // Interceptar API para retornar dados inv√°lidos
    await page.route('**/api/endpoints/buscar-di.php**', route => {
      route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          success: true,
          data: {
            numero_di: '2300120746',
            adicoes: null, // Dados inv√°lidos
            importador_nome: null
          }
        })
      });
    });
    
    // Primeiro, adicionar DI real ao banco
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    await page.click('button:has-text("Limpar Banco")');
    await page.click('button:has-text("Confirmar")');
    
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles(path.join(__dirname, '..', 'orientacoes', '2300120746.xml'));
    await expect(page.locator('.upload-progress')).toBeHidden({ timeout: 60000 });
    
    // Navegar para Module 2
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Tentar selecionar DI com dados inv√°lidos
    const diSelector = page.locator('select[name="di_number"], #di-select');
    await diSelector.selectOption('2300120746');
    
    // Aguardar erro aparecer
    await page.waitForTimeout(3000);
    
    // Verificar que erro √© exibido (fail-fast)
    const errorVisible = await page.locator('.error-message, .validation-error, .data-error').isVisible();
    
    if (errorVisible) {
      console.log('‚úÖ Sistema falha explicitamente com dados inv√°lidos');
    } else {
      // Verificar que interface n√£o carregou dados inv√°lidos
      const diInfo = page.locator('.di-info');
      const hasValidData = await diInfo.isVisible() && await diInfo.textContent();
      expect(hasValidData).toBeFalsy();
      console.log('‚úÖ Sistema n√£o carrega dados inv√°lidos');
    }
  });

  test('TESTE: C√°lculo sem dados ‚Üí Erro expl√≠cito', async ({ page }) => {
    console.log('üßÆ Testando c√°lculo sem dados obrigat√≥rios...');
    
    // Navegar para Module 2 com banco vazio
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    await page.click('button:has-text("Limpar Banco")');
    await page.click('button:has-text("Confirmar")');
    
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Tentar executar c√°lculo sem DI selecionada
    const calcularBtn = page.locator('button:has-text("Calcular"), #calcular-impostos');
    
    if (await calcularBtn.isVisible() && await calcularBtn.isEnabled()) {
      await calcularBtn.click();
      
      // Aguardar erro aparecer
      await page.waitForTimeout(2000);
      
      // Verificar que erro √© exibido
      const errorMessage = page.locator('.error-message, .calculation-error, .validation-error');
      await expect(errorMessage).toBeVisible({ timeout: 10000 });
      
      console.log('‚úÖ C√°lculo falha explicitamente sem dados');
    } else {
      console.log('‚úÖ Bot√£o calcular desabilitado sem dados');
    }
  });

  test('TESTE: Export sem c√°lculo ‚Üí Erro expl√≠cito', async ({ page }) => {
    console.log('üìä Testando export sem c√°lculo realizado...');
    
    // Importar DI mas n√£o executar c√°lculo
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    await page.click('button:has-text("Limpar Banco")');
    await page.click('button:has-text("Confirmar")');
    
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles(path.join(__dirname, '..', 'orientacoes', '2300120746.xml'));
    await expect(page.locator('.upload-progress')).toBeHidden({ timeout: 60000 });
    
    // Navegar para Module 2
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Selecionar DI
    const diSelector = page.locator('select[name="di_number"], #di-select');
    await diSelector.selectOption('2300120746');
    await expect(page.locator('.loading-indicator')).toBeHidden({ timeout: 30000 });
    
    // Tentar export sem c√°lculo
    const exportBtn = page.locator('button:has-text("Exportar Excel"), #export-excel');
    
    if (await exportBtn.isVisible() && await exportBtn.isEnabled()) {
      await exportBtn.click();
      
      // Aguardar erro ou verificar que nada aconteceu
      await page.waitForTimeout(3000);
      
      // Verificar que erro √© exibido ou export n√£o aconteceu
      const errorMessage = page.locator('.error-message, .export-error, .validation-error');
      const hasError = await errorMessage.isVisible();
      
      if (hasError) {
        console.log('‚úÖ Export falha explicitamente sem c√°lculo');
      } else {
        console.log('‚úÖ Export n√£o executado sem c√°lculo');
      }
    } else {
      console.log('‚úÖ Bot√£o export desabilitado sem c√°lculo');
    }
  });

  test('TESTE: Reconex√£o ap√≥s falha de API', async ({ page }) => {
    console.log('üîÑ Testando reconex√£o ap√≥s falha de API...');
    
    let apiBlocked = true;
    
    // Interceptar APIs inicialmente bloqueadas
    await page.route('**/api/endpoints/**', route => {
      if (apiBlocked) {
        route.abort('failed');
      } else {
        route.continue();
      }
    });
    
    // Tentar navegar com APIs bloqueadas
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    await page.waitForTimeout(3000);
    
    // Verificar estado de erro
    const hasInitialError = await page.locator('.error-message, .connection-error').isVisible();
    const hasEmptyState = await page.locator('.gate-database-empty, .no-data-message').isVisible();
    
    expect(hasInitialError || hasEmptyState).toBeTruthy();
    console.log('‚úÖ Estado de erro confirmado com APIs bloqueadas');
    
    // Primeiro, preparar dados no banco
    apiBlocked = false; // Liberar APIs
    
    await page.goto(`${BASE_URL}/sistema-expertzy-local/xml-import/import-dashboard.html`);
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles(path.join(__dirname, '..', 'orientacoes', '2300120746.xml'));
    await expect(page.locator('.upload-progress')).toBeHidden({ timeout: 60000 });
    
    // Voltar para Module 2 com APIs funcionando
    await page.goto(`${BASE_URL}/sistema-expertzy-local/di-processing/di-processor.html`);
    await page.waitForLoadState('networkidle');
    
    // Verificar que sistema se recupera
    const diSelector = page.locator('select[name="di_number"], #di-select');
    await expect(diSelector.locator('option:has-text("2300120746")')).toBeVisible({ timeout: 30000 });
    
    console.log('‚úÖ Sistema se recupera quando APIs voltam a funcionar');
  });

});